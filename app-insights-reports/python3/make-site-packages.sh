#!/bin/bash

LOCAL_DIR=$(pushd $(dirname $0) >/dev/null; pwd)

SITE_LOCATION=$1
shift 1

if [[ -z "$SITE_LOCATION" ]] || [[ -z "$*" ]]; then
  echo "usage: $0 </path/to/new/site> <pip install parameters>"
  echo "ex: $0 /tmp/here -r /some/requirements.txt"
fi

echo "Site location: $SITE_LOCATION"
echo "Pip commands: $*"

VENV_LOCATION=$SITE_LOCATION

$LOCAL_DIR/bin/python -m venv --system-site-packages --without-pip $VENV_LOCATION

source $VENV_LOCATION/bin/activate

export LD_LIBRARY_PATH="$LOCAL_DIR/so_lib/lib64:$LOCAL_DIR/so_lib/lib"
echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH"

$VENV_LOCATION/bin/python -m pip install --index-url http://cerdo.unraveldata.com/artifactory/api/pypi/pypi/simple --trusted-host cerdo.unraveldata.com $*

$VENV_LOCATION/bin/python -m pip freeze --local > $SITE_LOCATION/requirements.txt

for f in $(find $VENV_LOCATION -name __pycache__); do
  rm -rf $f
done
